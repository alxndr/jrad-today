<script context="module">
	export async function load({fetch}) {
		const response = await fetch('https://github.com/alxndr/almost-dead-net/raw/main/src/data/csv/shows.csv')
		if (response.status === 200) {
			const csvString = await response.text()
			return {
				status: 200,
				props: {
					csvString,
				},
			}
		}
		return {
			status: response.status,
		}
	}
</script>

<script>
  import { getStores, navigating, page, session, updated } from '$app/stores'
	import Papa from 'papaparse'
  function dateToMD(date) {
    if (!date.getMonth || !date.getDate) throw new Error('Unexpected date param', date)
    return `${date.getMonth() + 1}/${date.getDate()}`
  }
  console.log({page})
	const {csvString = ''} = arguments?.[1] // TODO this doesn't feel like the Right way to do it...
	let allShows = []
	Papa.parse(csvString, {
		header: true,
		complete: function(results) {
			allShows = results.data
		}
	})
  function showsOnDate(dateMD) {
    return show => dateMD === show?.date?.split('/').slice(0,2).join('/')
  }
  const todayMD = dateToMD(new Date())
  let mutatingDate = new Date()
  mutatingDate.setDate(mutatingDate.getDate() - 1)
  const yesterdayMD = dateToMD(mutatingDate)
  mutatingDate = new Date()
  mutatingDate.setDate(mutatingDate.getDate() + 1)
  const tomorrowMD = dateToMD(mutatingDate)
	let anniversaryShows = []
  let yesterdayShows = []
  let tomorrowShows = []
	$: {
		anniversaryShows = allShows.filter(showsOnDate(todayMD))
    yesterdayShows = !anniversaryShows.length &&
      allShows.filter(showsOnDate(yesterdayMD))
    tomorrowShows = !anniversaryShows.length &&
      allShows.filter(showsOnDate(tomorrowMD))
	}
</script>

<svelte:head>
  <title>About</title>
</svelte:head>

<h1>Today in JRAD History: {todayMD}</h1>

{#if anniversaryShows.length}
	<ul>
		{#each anniversaryShows as show}
			<li><a href={`https://almost-dead.net/show/${show.id}`}>{show.tagline}</a></li>
		{/each}
	</ul>
{:else}
	<p>No shows played on this date... yet!</p>
  {#if yesterdayShows.length}
    <p>Yesterday's anniversary:</p>
    <ul>
      {#each yesterdayShows as show}
        <li><a href={`https://almost-dead.net/show/${show.id}`}>{show.tagline}</a></li>
      {/each}
    </ul>
  {/if}
  {#if tomorrowShows.length}
    <p>Tomorrow's anniversary:</p>
    <ul>
      {#each tomorrowShows as show}
        <li><a href={`https://almost-dead.net/show/${show.id}`}>{show.tagline}</a></li>
      {/each}
    </ul>
  {/if}
{/if}

<style>
	h1 { text-align: center; }
</style>
